<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css">
		<!--App自定义的css-->

		<link href="css/mystyle.css" rel="stylesheet">
	
	</head>

	<body>

		<style>
			.mui-control-content {
				background-color: white;
				min-height: 215px;
			}
			
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			
			.nearsite-message {
				display: inline-block;
				clear: both;
				margin: 10px;
			}
			
			.nearsite-message .avatar {
				float: left;
			}
			
			.nearsite-message .avatar img {
				width: 30px;
				height: 30px;
				border-radius: 50%;
			}
			
			.nearsite-message .content {
				float: left;
				background: #fff;
				margin: 0 10px 10px 10px;
				padding: 10px;
				border-radius: 7px;
				max-width: 90%;
				position: relative;
				min-height: 20px;
				font-size: 15px;
			}
			
			.nearsite-message .content img {
				width: 100%;
			}
			
			.nearsite-message .triangle {
				height: 0px;
				width: 0px;
				border-width: 8px;
				border-style: solid;
				position: absolute;
				top: 6px;
				border-color: transparent #fff transparent transparent;
				left: -16px;
			}
			
			.vertbar {
				width: 1px;
				height: 50px;
				background-color: #a2a2a2;
				margin: -34px 25px -8px;
			}
		</style>
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			
			footer {
				position: absolute;
				z-index: 1;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
			}
			
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			
			.footer-center .input-sound {
				background-color: #eee;
			}
			
			.mui-content2 {
				height: 100%;
				padding: 0px 0px 50px 0px;
				overflow: auto;
			}
			
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			
			.msg-item {
				padding: 8px;
				clear: both;
			}
			
			.msg-item .mui-item-clear {
				clear: both;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				padding: 3px;
				color: #ddd;
			}
			
			.msg-item .msg-user-img {
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			
			footer .mui-icon {
				color: #000;
			}
			
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			
			.r-sigh {
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			
			.rprogress-sigh {
				background-image: none !important;
			}
			
			.rprogress-sigh .rschedule {
				display: none !important;
			}
			
			.rprogress-sigh .r-sigh {
				display: block !important;
			}
			
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			
			.cancel {
				background-color: darkred;
			}
			.case_content_report p{
				 margin-bottom:4px;
				color: #505050;
			}
			.case_content_report li h6 {
    font-size: 16px;
    color: #51c4d4;
    line-height: 20px;
}
		</style>

		<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable mui-slide-in" style="z-index: 99; ">
			<!--菜单部分-->
			<aside id="offCanvasSide" class="mui-off-canvas-right" style="max-width: 300px;">
				<div id="offCanvasSideScroll" class="mui-scroll-wrapper" style="background: white; ">
					<div class="mui-scroll" >
						
						<button id="offCanvasHide" type="button" class="mui-btn mui-btn-danger mui-btn-block" style="padding: 5px 20px;">关闭菜单</button>
						<div id="div_zd">
						<div style="color: #0062CC; padding: 4px;">&nbsp;<i style="font-size: 18px; " class="fa fa-eye "></i>镜下所见：</div>
						<div style="padding: 4px;">
							<textarea id="txt_z_Mirror" style="margin: 0px;" maxlength="500"></textarea></div>
						<div style="color: #0062CC;padding: 4px"><i style="font-size: 18px; " class="fa fa-stethoscope  "></i>专家诊断意见：</div>
						<div style="padding: 4px;" class="mui-input-row">
							<textarea id="txt_Diagnosis" style="margin: 0px; height: 120px;" maxlength="1000"></textarea>
						</div>
						<div style="color: #0062CC;padding: 4px"><i style="font-size: 18px; " class="fa fa-tag " style="margin-left: 5px;">
                                                                            </i>诊断备注：</div>
						<div style="padding: 4px;">
							<textarea id="txt_remark" style="margin: 0px;" maxlength="200"></textarea>
						</div>
						<div align="center" style="padding: 4px;">
							<div id="div_tool">
								<div>
									<button class="mui-btn mui-btn-primary mui-icon mui-icon-plus" onclick="savaDraft()">保存记录</button>
									<button class="mui-btn mui-btn-primary mui-icon mui-icon-paperplane" onclick="GenerateReport()">生成报告</button>

								</div>

								<div align="center" style="padding: 4px;">
									<button class="mui-btn mui-btn-primary mui-icon mui-icon-undo" onclick="returnCase()">退回病例</button>
									<button class="mui-btn mui-btn-primary mui-icon mui-icon-personadd-filled" onclick="invitedCase()">邀请专家</button> </div>

							</div>
						</div>
					
                        <div id="div_tool2" align="center">
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-search" onclick="LookReport()">查看报告</button>
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-star" id="btncollection" onclick="Collection()" >收藏病例</button>
						</div>
							</div>
				    	<div id="div_sy">
						<div style="color: #0062CC; padding: 4px;">&nbsp;<i style="font-size: 18px; " class="fa fa-eye "></i>受邀备注：</div>
						<div style="padding: 4px;">
							<textarea id="txt_sy_bz" style="margin: 0px;" readonly="readonly"></textarea></div>
							<div style="color: #0062CC; padding: 4px;">&nbsp;<i style="font-size: 18px; " class="fa fa-eye "></i>回复诊断意见：</div>
						<div style="padding: 4px;">
							<textarea id="txt_sy_zd" style="margin: 0px; height: 150px;" ></textarea></div>
							<div  align="center">
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-navigate" id="btn_InvitedAsk" onclick="InvitedAsk()">确认回复</button>
							
						</div>
					</div>
					<div id="div_fh">
					    <div style="color: #0062CC; padding: 4px;">&nbsp;<i style="font-size: 18px; " class="fa fa-eye "></i>退回理由：</div>
						<div style="padding: 4px;">
							<textarea id="txt_fh_ly" style="margin: 0px; height: 150px;" maxlength="150"></textarea>
						</div>
						<div style="color: #0062CC; padding: 4px;">&nbsp;<i style="font-size: 18px; " class="fa fa-eye "></i>复核意见：</div>
						<div style="padding: 4px;">
							<textarea id="txt_fh_text" style="margin: 0px; height: 150px;" maxlength="1000"></textarea>
						</div>
					    <div id="div_fh_btn"  align="center">
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-navigate" onclick="GenerateReport()">复核签名</button>
							&nbsp;
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-undo" onclick="backreview()" >退回复核</button>
					    </div>
					    
					    <div id="div_tool2_review" align="center" style="display: none;">
							<button class="mui-btn mui-btn-primary mui-icon mui-icon-search" onclick="LookReport()">查看报告</button>
						</div>
					</div>
				</div>
			</aside>
			<div class="mui-inner-wrap">
				<div class="mui-off-canvas-backdrop"></div>
				<header class="mui-bar mui-bar-nav" style="background-color:#3188DE; ">
					<a style="color: white;" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"> </a>
					<h1 class="mui-title" style="color: white;" id="statustitle">待诊断</h1>
					<a id="offCanvasBtn" href="#offCanvasSide" style="font-size: 22px;" class="mui-icon mui-action-menu mui-icon-compose mui-pull-right"><span style="font-size: 16px;" id="sp_righthead">填写诊断</span></a>
					<div id="topPopover" class="mui-popover">
						<div class="mui-popover-arrow"></div>
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view" id="consultStatuslist">
									<li class="mui-table-view-cell li_consult" data-id="">
										<a href="#">全部状态</a>
									</li>
									<li class="mui-table-view-cell li_consult" data-id="1">
										<a href="#">待诊断</a>
									</li>
									<li class="mui-table-view-cell li_consult" data-id="2">
										<a href="#">已诊断</a>
									</li>
									<li class="mui-table-view-cell li_consult" data-id="3">
										<a href="#">退回</a>

									</li>
									<li class="mui-table-view-cell li_consult" data-id="4">
										<a href="#">收藏</a>
									</li>
									<li class="mui-table-view-cell li_consult" data-id="5">
										<a href="#">受邀</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</header>
				<div class="mui-content" style="background-color: white">
					<div id="slider" class="mui-slider mui-fullscreen">
						<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
							<a class="mui-control-item" href="#item1mobile">
								病例
							</a>
							<a class="mui-control-item" href="#item2mobile">
								切片<span class="mui-badge mui-badge-primary" style="position: absolute; margin-left: -6px;" id="sp_slidecount">0</span>
							</a>
							<a class="mui-control-item" href="#item3mobile">
								附件<span class="mui-badge mui-badge-primary" style="position: absolute; margin-left: -6px;" id="sp_annexcount">0</span>
							</a>
							<a class="mui-control-item" href="#item4mobile">
								留言
							</a>
							<a class="mui-control-item" href="#item5mobile">
								受邀
							</a>
						</div>
						<div id="sliderProgressBar" class="mui-slider-progress-bar" style="width: 20%;"></div>
						<div class="mui-slider-group">
							<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
								<div id="scroll1" class="mui-scroll-wrapper" style="height: auto;">
									<div class="mui-scroll">
										<div class="mui-loading" id="caseloading">
											<div class="mui-spinner">
											</div>
										</div>
										<div id="divcase" style="display: none">
										<ul class="case_content_report" >
											
											<li style="margin: 0px 15px; padding: 2px 0px;">
												<p><span>原病理号：</span><span id="sp_caseno"></span></p>
												<p><span>患者信息：</span><span id="sp_info"></span></p>
												<p><span>送检单位：</span><span id="sp_SendHos"></span></p>
												<p><span>送检时间：</span><span id="sp_Received_Date"></span></p>
												<p><span>取材部位：</span><span id="sp_MaterialParts"></span></p>
												<p><span>临床诊断：</span><span id="sp_z_Digagnosis"></span></p>
											</li>
											<li style="margin: 0px 15px;border-top: 1px solid #e7e7e7; padding: 2px 0px;">
												<h6>临床资料</h6>
												<p><span id="sp_Clinical_Data"></span></p>
											</li>
											
											<li style="margin: 0px 15px;border-top: 1px solid #e7e7e7; padding: 2px 0px;">
												<h6>大体所见</h6>
												<p><span id="sp_Gennerally_See"></span></p>
											</li>
											<li style="margin: 0px 15px;border-top: 1px solid #e7e7e7; padding: 2px 0px;">
												<h6>免疫组化</h6>
												<p><span id="sp_Immune_Group"></span></p>
											</li>
											
											<li style="margin: 0px 15px;border-top: 1px solid #e7e7e7; padding: 2px 0px;">
												<h6>原病理诊断</h6>
												<p><span id="sp_Early_Digagnosis"></p>
											</li>
											<li style="margin: 0px 15px;border-top: 1px solid #e7e7e7; padding: 2px 0px;">
												<h6>备注</h6>
												<p><span id="sp_Remark"></p>
											</li>
										</ul>
										</div>
								</div>
							</div>
							</div>
							<div id="item2mobile" class="mui-slider-item mui-control-content">
								<div id="scroll2" class="mui-scroll-wrapper">
									<div class="mui-scroll">

										<ul class="mui-table-view mui-col-xs-12" id="slidelist">
											<div class="mui-loading">
												<div class="mui-spinner">
												</div>
											</div>

										</ul>

									</div>
								</div>

							</div>
							<div id="item3mobile" class="mui-slider-item mui-control-content">
								<div id="scroll3" class="mui-scroll-wrapper">
									<div class="mui-scroll">
										<ul class="mui-table-view mui-col-xs-12" id="annexlist">
											<div class="mui-loading">
												<div class="mui-spinner">
												</div>
											</div>

										</ul>
									</div>
								</div>

							</div>
							<div id="item4mobile" class="mui-slider-item mui-control-content">
								<div id="scroll4" class="mui-scroll-wrapper">
									<div class="mui-scroll" id="xsroll">
										<div class="mui-content2">
											<pre id='h'></pre>
											<div id="msg-list" style=" overflow-y: auto;-webkit-overflow-scrolling : touch;  ">
												<div class="mui-loading">
													<div class="mui-spinner">
													</div>
												</div>
											</div>
										</div>
									</div>

								</div>

							</div>
							<div id="item5mobile" class="mui-slider-item mui-control-content">
								<div id="scroll5" class="mui-scroll-wrapper">
									<div class="mui-scroll">
										<ul class="mui-table-view mui-table-view-striped mui-table-view-condensed" id="invitedlist">
											<div class="mui-loading">
												<div class="mui-spinner">
												</div>
											</div>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
			<footer id="footerid" style="display: none;">
				<div class="footer-left" style="display:none">
					<i id='msg-image' class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
				</div>
				<div class="footer-center" style="margin-left:-40px ;">
					<textarea id='msg-text' type="text" class='input-text' maxlength="150" placeholder="每一条留言有150字的长度限制"></textarea>
					<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>
				</div>
				<label for="" class="footer-right">
				<i id='msg-type' class="mui-icon mui-icon-paperplane"></i>
			</label>
			</footer>

		</div>

		<!--<div>

			<div class="mui-backdrop mui-active" style="display: none;" id="div_over">
				<div class="mui-loading" style="position: absolute; top:50%; left: 50%;">
					<div class="mui-spinner">

					</div>
					<div style="font-weight: bold;">报告生成中...</div>
				</div>
			</div>
		</div>-->
		<div id="topPopover2" class="mui-popover" style="position: fixed;">
			<div class="mui-popover-arrow"></div>

			<div style="padding: 4px;"><textarea id="p_return" style="margin: 0px;height: 150px;" readonly="readonly"></textarea></div>
		</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery-1.11.0.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="js/common.js"></script>
		<script src="js/mui.lazyload.js"></script>
		<script src="js/mui.lazyload.img.js"></script>
		<script>
			//判定是否站点是否连接
			var SiteStatus;
			
			// 计算tabs下宽度
			evaluateWidth();
			function evaluateWidth() {
				if (mui.os.ipad) {
					jQuery('#sliderProgressBar').css('width', ((window.screen.height-255) / 5));
				console.log('这是需要的Width' + jQuery('.mui-slider-progress-bar').css('width'));
				} else {
					console.log('非iPad客户端');
				}
			}
		    
			var slidedata = [
				'<li class="mui-table-view-cell mui-media">',
					'<a class="mui-navigate-right slide @slideState" data-Status="@Status" data-id="@kfbpath" data-name="@Aslidename">',
						'<img class="mui-media-object mui-pull-left" data-lazyload="@labelurl">',
						'<img class="mui-media-object mui-pull-left" data-lazyload="@thumburl">',
						'<div class="mui-media-body">@slidename',
							'<div class="mui-badge mui-btn-success" style="@slidetypeshow">@slidedataMessage</div>',
							'<p class="mui-ellipsis">@ranse</p>',
						'</div>',
					'</a>',
				'</li>'
			]
			
			var annexdata = [
				'<li class="mui-table-view-cell mui-media">',
					'<a class="mui-navigate-right annex @annexState" data-id="@AnnexPath" data-name="@Xannexame" data-Status="@Status" data-ClientPath="@ClientPath">',
						'<img class="mui-media-object mui-pull-left" src="images/annex.png">',
						'<div class="mui-media-body">@AnnexName',
							'<div class="mui-badge mui-btn-success" style="@annextypeshow">@annexdataMessage</div>',
							'<p class="mui-ellipsis">@AnnexType</p>',
						'</div>',
					'</a>',
				'</li>'
			]
			var messagedata = [
				'<div class="msg-item @self" >@selfimg',
				'<div class="msg-content">',
				'<div class="msg-content-inner">@message<br/>[@time]</div>',
				'<div class="msg-content-arrow"></div>',
				'</div>',
				'<div class="mui-item-clear"></div>',
				'</div>'
			]
			var inviteddata = [
				'<li class="mui-table-view-cell invite">',
				' <div class="mui-table">',
				' <div class="mui-table-cell mui-col-xs-10">',
				'<h4>专家：@displayname</h4>',
				'<h5>回复时间：@DiagnosisTime</h5>',
				'<p >回复：@xDiagnosis</p>',
				'</div>',
				'</div>',
				'</li>',
			]
			var viewerurl = coreurl+"/Viewer";
			var _ConsultID = 0;
			var _CaseNo = "";
			var _ip = "";
			var _port = "";
			var _IsCollect=0;
			var deceleration = mui.os.ios ? 0.003 : 0.0009;
			var wating;
			
			mui.init({
				swipeBack: false,
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			
			//初始化
			mui.ready(function() {
				var ConsultID = getQueryString2("ConsultID");
				_ConsultID = ConsultID;
				LoadCase(ConsultID);
				LoadControl();
			});
			
			//加载留言
			function LoadMessage(ConsultID, flag) {
				if(jQuery('#msg-list div').hasClass('msg-item') == false || flag == true) {
					var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					jQuery.ajax(resturl + 'Message', {
						data: {
							ConsultID: ConsultID
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'get', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						cache: false,
						success: function(data) {
							var div = "";
							data = eval(data);
							if(data.length > 0) {
								for(var i = 0; i < data.length; i++) {
									var selfclass = "msg-item-self";
									var selfimg = "<i class=\"msg-user mui-icon mui-icon-person\"></i>"
									if(data[i].RoleID != 2) {
										selfclass = "";
										selfimg = "<img class=\"msg-user-img\" src=\"images/HisLogo.png\" alt=\"\" style=\"width:38px;\"/>";
									}
									div += messagedata.join('').replace(/@message/, data[i].Message)
										.replace(/@self/, selfclass)
										.replace(/@selfimg/, selfimg)
										.replace(/@time/, data[i].MessageTime.replace('T', ' '))
								}

								jQuery("#msg-list").html(div);
								if(flag == true) {

									var xheight = jQuery("#msg-list").height();
									mui('#scroll4').scroll().scrollTo(0, -xheight, 100);
									mui('#scroll4').scroll().refresh();
								}

							}
							else{
								jQuery('#msg-list').html("<div align=\"center\"><p>暂无留言</p></div>");
								
							}

						},
						error: function(xhr, type, errorThrown) {
							if(type == 'timeout') {
								mui.toast("网络不给力，请重新操作！");

							}
						}
					});
				}

			}
			
			//加载附件
			function LoadAnnex(ConsultID) {
				var URL = "http://" + getQueryString2("DiagHisIp") + ":" + getQueryString2("DiagHisPort") + "";
				if(jQuery('#annexlist li').hasClass('mui-media') == false) {

					jQuery.ajax(resturl + 'GetAnnexDataMode', {
						data: {
							ConsultID: ConsultID,
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'get', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						cache: false,
						success: function(data) {
							var div = "";
							data = eval(data);
							if(data.length > 0) {
								for(var i = 0; i < data.length; i++) {
									var annextypeshow = "display:none";
									var path = data[i].Path;
									var annexpath = path.replace(new RegExp(/(\\)/g), '\\\\');
									var ClientPath=data[i].ClientPath.replace(new RegExp(/(\\)/g), '\\\\');
									// 云切片，上传中显示
									var message = "";
									// 是否上传完成标志位
							        var state = "annexComplete";
									if (data[i].Status != "1") {
										if (SiteStatus == 1) {
											annextypeshow="";
											message = "云数据";
										} else {
											annextypeshow="";
											message = "上传中";
											state = "annexLoading";
										}
									} 
									
									div += annexdata.join('').replace(/@AnnexName/, data[i].AnnexName)
										.replace(/@AnnexType/, data[i].AnnexType)
										.replace(/@AnnexPath/, annexpath)
										.replace(/@Xannexame/, data[i].AnnexName + "(" + data[i].AnnexType + ")")
										.replace(/@Status/, data[i].Status)
										.replace(/@ClientPath/,ClientPath)
										.replace(/@annextypeshow/, annextypeshow)
										.replace(/@annexdataMessage/, message)
										.replace(/@annexState/, state);
										
								}
								
								jQuery('#annexlist').html(div);
									mui('.mui-table-view').on('tap', '.annexComplete', function() {
									var jumpurl = "";
									var annexpath = this.getAttribute('data-id');
									var Status=this.getAttribute('data-Status');
									
									if(Status!="1"){
										annexpath=this.getAttribute('data-ClientPath');
									}
									
									
									if(annexpath.indexOf('.pdf') != -1) {
										jumpurl = "pdfviewer.html?annexpath=" + escape(encodeURI(annexpath)) + "&annexUrl=" + URL + "&Status=" + Status + "&title=" + escape(encodeURI(this.getAttribute('data-name')));					
									} else {
										jumpurl = "picviewer.html?annexpath=" + escape(encodeURI(annexpath)) + "&annexUrl=" + URL + "&Status=" + Status + "&title=" + escape(encodeURI(this.getAttribute('data-name')));
									}
									jump(jumpurl, 'school_detail3', {

									});

								});
							}else{
								jQuery('#annexlist').html("<div align=\"center\"><p>无附件上传</p></div>");
								
							}

						},
						error: function(xhr, type, errorThrown) {
							if(type == 'timeout') {
								mui.toast("网络不给力，请重新操作！");

							}
						}
					});
				}

			}

			//加载切片
			function LoadSlide(ConsultID) {
				var URL = "http://" + getQueryString2("DiagHisIp") + ":" + getQueryString2("DiagHisPort") + "";
					
				if(jQuery('#slidelist li').hasClass('mui-media') == false) {
					jQuery.ajax(resturl + 'GetSlideDataMode', {
						data: {
							ConsultID: ConsultID,
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'get', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						cache: false,
						success: function(data) {
							var div = "";
							data = eval(data);
							if(data.length > 0) {
								for(var i = 0; i < data.length; i++) {
									var ranse = "HE";
									var UncToken = "";
									var kfbpath = data[i].Path.replace(new RegExp(/(\\)/g), '\\\\');
								    var slidetypeshow = "display:none";
									if(data[i].RanSe == "0") {
										ranse = "其他";
									} else if(data[i].RanSe == "2") {
										ranse = "免疫组化";
									} else if(data[i].RanSe == "3") {
										ranse = "其它染色";
									}
									if(data[i].UncToken != "") {
										UncToken = "&UncToken=" + data[i].UncToken;
									}
									
									// 标志是否完成
							        var message = "";
							        // 是否上传完成标志位
							        var state = "slideComplete";
									
									//console.log("选择的Status是：" + data[i].Status);
									if (data[i].Status == "1") {
							            var LabUrl = viewerurl + "/LabelHandler.ashx?kfbpath=" + encodeURI(kfbpath);
										var PreUrl = viewerurl + "/ThumnailHandler.ashx?kfbpath=" + encodeURI(kfbpath);
							        }
							        else {
							        	if (SiteStatus == 1) {
							        		slidetypeshow="";
							        		message = "云数据";
							        	} else {
							        		slidetypeshow="";
							        		message = "上传中";
							        		state = "slideLoading";
							        	}
            							var ClientPath = data[i].ClientPath;            
						                kfbpath = ClientPath.replace(new RegExp(/(\\)/g), '\\\\');
						                PreUrl = "" + URL + "/API/ThumnailHandler?kfbpath=" + encodeURI(ClientPath);
						                LabUrl = "" + URL + "/API/LabelHandler?kfbpath=" + encodeURI(ClientPath);
						               
							        }
									div += slidedata.join('').replace(/@labelurl/, LabUrl)
										.replace(/@thumburl/, PreUrl)
										.replace(/@slidename/, data[i].SlideName)
										.replace(/@ranse/, ranse)
										.replace(/@kfbpath/, kfbpath)
										.replace(/@Aslidename/, data[i].SlideName + "(" + ranse + ")")
										.replace(/@Status/, data[i].Status)
										.replace(/@slidetypeshow/, slidetypeshow)
										.replace(/@slidedataMessage/, message)
										.replace(/@slideState/, state);
								}
								jQuery('#slidelist').html(div);
								(function($) {
									$(document).imageLazyload({
										placeholder: 'images/60x60.gif'
									});
								})(mui);
									mui('.mui-table-view').on('tap', '.slideComplete', function() {
										var Status=this.getAttribute('data-Status');
										if(Status=="1"){
											//var url = viewerurl + "/Html5/SeadragonViewer.aspx";
											var jumpurl = "slideviewer.html?lang=zh-cn&CaseNo=" + _ConsultID + "&kfbpath=" + encodeURI(escape(this.getAttribute('data-id'))) + "&SwitchCut=1&ToolBottom=40&title=" + encodeURI(this.getAttribute('data-name')) + "";
											jump(jumpurl, 'slideviewer', {
											});
										}else{
											var jumpurl = "slideviewer2.html?lang=zh-cn&URL=" + URL + "&CaseNo=" + ConsultID + "&kfbpath=" + encodeURI(escape(this.getAttribute('data-id')))  + "&SwitchCut=1&title=" + encodeURI(this.getAttribute('data-name')) + "";
											jump(jumpurl, 'slideviewer2', {
												
											});
										}
										});
							}else{
								jQuery('#slidelist').html("<div align=\"center\"><p>无切片上传</p></div>");
							}
						},
						error: function(xhr, type, errorThrown) {
							if(type == 'timeout') {
								mui.toast("网络不给力，请重新操作！");
							}
						}
					});
				}
			}
			 
			//加载病例
			function LoadCase(ConsultID) {
				isComplete();
				
				var userInfo = localStorage.getItem("userInfo");
				var user = userInfo ? window.eval("(" + userInfo + ")") : "";
				jQuery.ajax(resturl + 'Case', {
					data: {
						ConsultID: ConsultID,
						UserID:user.userid
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'get', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);

						if(data.length > 0) {
							_CaseNo = data[0].Case_No;
							jQuery("#sp_info").html(data[0].Name + " " + data[0].Sex + " " + data[0].Age);
							jQuery("#sp_caseno").html(data[0].Case_No);
							jQuery("#sp_z_Marriage").html(data[0].z_Marriage);
							jQuery("#sp_SendHos").html(data[0].SendHos);
							jQuery("#sp_Clinical_Data").html(data[0].Clinical_Data);
							jQuery("#sp_z_Digagnosis").html(data[0].z_Digagnosis);
							
							var Gennerally_See=data[0].Gennerally_See//大体所见
							if(Gennerally_See==""){
								Gennerally_See="无";
							}
							jQuery("#sp_Gennerally_See").html(Gennerally_See);
							
							var Immune_Group=data[0].Immune_Group//免疫组化
							if(Immune_Group==""){
								Immune_Group="无";
							}
							jQuery("#sp_Immune_Group").html(Immune_Group);
							
							var Early_Digagnosis=data[0].Early_Digagnosis//原病理诊断
							if(Early_Digagnosis==""){
								Early_Digagnosis="无";
							}
							jQuery("#sp_Early_Digagnosis").html(Early_Digagnosis);
							
							jQuery("#caseloading").css("display", "none");
							jQuery("#divcase").css("display", "");
							jQuery("#sp_slidecount").html(data[0].slidecount);
							jQuery("#sp_annexcount").html(data[0].annexcount);
							
							if(getQueryString2("ConsultStatusID")==1){
								
							
							}
							else if(getQueryString2("ConsultStatusID")==4||getQueryString2("ConsultStatusID")==2){
								jQuery("#txt_fh_text").val(data[0].Diagnosis);
								jQuery("#txt_Diagnosis").val(data[0].Diagnosis);
							    jQuery("#txt_remark").val(data[0].Diagnosis_Remark);
							    jQuery("#txt_z_Mirror").val(data[0].z_Mirror);
							}

							jQuery("#p_return").html(data[0].RecheckReturn);
							jQuery("#sp_Received_Date").html(data[0].Received_Date);
							jQuery("#sp_MaterialParts").html(data[0].MaterialParts);
							jQuery("#sp_z_Digagnosis").html(data[0].z_Digagnosis);
							jQuery("#txt_sy_bz").val(data[0].InviteReason);
							jQuery("#txt_sy_zd").val(data[0].DiagnosisReason);
							var Remark=data[0].Remark//原病理诊断
							if(Remark==""){
								Remark="无";
							}
							jQuery("#sp_Remark").html(Remark);
							_IsCollect=data[0].IsCollect;
							if(_IsCollect==null)
							{
								_IsCollect=0;
							}
							

							if(_IsCollect==0)
							{
								jQuery("#btncollection").removeClass("mui-icon-star-filled")
								jQuery("#btncollection").addClass("mui-icon-star")
							 
							}
							else
							{
						    	jQuery("#btncollection").removeClass("mui-icon-star")
								jQuery("#btncollection").addClass("mui-icon-star-filled")
							}
							
						}

					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							_error = new Error(jQuery('body'), '网络不给力呀亲...');
							_error.show();
						}
					}
				});

			}
			
			//加载受邀数据
			function Loadinvited() {
				if(jQuery('#invitedlist li').hasClass('invite') == false) {
					var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					jQuery.ajax(resturl + 'GetinvitedInfo', {
						data: {
							ConsultID: _ConsultID,
							UserID: user.userid
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'get', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						cache: false,
						success: function(data) {
							data = eval(data);
							var div = "";
							if(data.length > 0) {
								for(var i = 0; i < data.length; i++) {
									div += inviteddata.join('').replace(/@displayname/, data[i].displayname)
										.replace(/@xDiagnosis/, data[i].Diagnosis)
										.replace(/@DiagnosisTime/, data[i].DiagnosisTime.replace('T', ' '))

								}
								jQuery("#invitedlist").html(div);

							}
							else{
								jQuery('#invitedlist').html("<div align=\"center\"><p>暂无受邀信息</p></div>");
								
							}

						},
						error: function(xhr, type, errorThrown) {
							if(type == 'timeout') {
								_error = new Error(jQuery('body'), '网络不给力呀亲...');
								_error.show();
							}
						}
					});
				}

			}
			
			//加载权限隐藏
			function LoadControl() {
				var ConsultStatusID = getQueryString2("ConsultStatusID");
				var IsRecheck = getQueryString2("IsRecheck");
				var type = getQueryString2("type");
				 	jQuery("#div_zd").css("display", "");
		           	jQuery("#div_sy").css("display", "none");
		           	jQuery("#div_fh").css("display", "none");
		        console.log("控制权限加载" + ConsultStatusID);
		        
		           	
				if(ConsultStatusID == "1") //待诊断
				{ 
					
					jQuery("#statustitle").html("待诊断");
					jQuery("#div_tool").css("display", "");
					jQuery("#div_tool2").css("display", "none");
					if(type=="99"){
						jQuery("#statustitle").html("已收藏");
						jQuery("#div_tool").css("display", "none");
				     	jQuery("#div_tool2").css("display", "");
				     	jQuery("#sp_righthead").text("查看诊断");
				    	jQuery("#txt_Diagnosis").attr("readonly",true);
						jQuery("#txt_remark").attr("readonly",true);
						jQuery("#txt_z_Mirror").attr("readonly",true);
					} else {
						GetDraft();
					}
				} 
				else if(ConsultStatusID == "-1"||ConsultStatusID == "-2") //已退回
				{ 
					jQuery("#statustitle").html("已退回");
					jQuery("#offCanvasBtn").css("display","none");
					
					
				} 
				else if(ConsultStatusID == "2") //复核中
				{
					if(IsRecheck == -1) {
						jQuery("#div_tool").css("display", "");
						jQuery("#div_tool2").css("display", "none");
						jQuery("#statustitle").html("<a href=\"#topPopover2\">复核退回<span class=\"mui-icon mui-icon-arrowdown\"></span></a>")
						
					    // 关闭退回端输入控制, 设置所有的输入为disabled
					    $("#txt_fh_ly").attr("disabled", "disabled");
					    $("#txt_fh_text").attr("disabled", "disabled");
					} else {
						jQuery("#statustitle").html("复核中");
						jQuery("#div_tool").css("display", "none");
						jQuery("#div_tool2").css("display", "");
					}
				} 
				else if(ConsultStatusID == "4") //已诊断
				{
					jQuery("#statustitle").html("已诊断");
					if(type=="99"){
						jQuery("#statustitle").html("已收藏");
					}
					jQuery("#div_tool").css("display", "none");
					jQuery("#div_tool2").css("display", "");
					jQuery("#sp_righthead").text("查看诊断");
				    jQuery("#txt_Diagnosis").attr("readonly",true)
					jQuery("#txt_remark").attr("readonly",true)
					jQuery("#txt_z_Mirror").attr("readonly",true)
				}
				//受邀
				 if(type== "98") //待回复
				{
					var isinviteted=getQueryString2("isinviteted")
					jQuery("#div_tool").css("display", "none");
		           	
		           	jQuery("#div_zd").css("display", "none");
		           	jQuery("#div_sy").css("display", "");

					if(isinviteted=="0"){
						jQuery("#sp_righthead").text("回复");
						jQuery("#statustitle").html("待回复");
					}
					else if(isinviteted=="1"){
						jQuery("#sp_righthead").text("查看回复");
						jQuery("#statustitle").html("已回复");
						jQuery("#txt_sy_zd").attr("readonly","readonly");
						jQuery("#btn_InvitedAsk").css("display","none");
					}
				}
				//复核
				 if(type== "97") 
				{
					var IsRecheck=getQueryString2("IsRecheck")
					jQuery("#div_tool").css("display", "none");
		           	
		           	jQuery("#div_zd").css("display", "none");
		           	jQuery("#div_sy").css("display", "none");
		           	jQuery("#div_fh").css("display", "");
		           	
					if(IsRecheck=="0"){
						jQuery("#sp_righthead").text("复核");
						jQuery("#statustitle").html("待复核");
					}
					else if(IsRecheck=="1"){
						jQuery("#sp_righthead").text("查看");
						jQuery("#statustitle").html("已复核");
						jQuery("#div_fh_btn").css("display", "none");
						
						// 锁定内容 退回理由，复核意见
						jQuery("#div_fh textarea").attr("disabled", "disabled");
						
						// 显示报告按钮
						jQuery("#div_tool2_review").css("display", "");
						
					}
					else if(IsRecheck=="-1"){
						LoadReviewReturn();
						jQuery("#sp_righthead").text("查看");
						jQuery("#statustitle").html("复核退回");
						jQuery("#div_fh_btn").css("display", "none");
					}
				}

			}
			
			mui('.mui-scroll-wrapper').scroll({
				bounce: false,
				indicators: true, //是否显示滚动条
				deceleration: deceleration
			});
			
			window.addEventListener('touchmove', function(e) {
				var target = e.target;
				if(target && target.tagName === 'TEXTAREA') { //textarea阻止冒泡
					e.stopPropagation();
				}
			}, true);
			
			//病例Tab事件
			document.querySelector(".mui-slider").addEventListener("slide", function(event) {
				//console.log("event.detail.slideNumber:" + event.detail.slideNumber);
				
				// 病例信息
				if(event.detail.slideNumber == 0) {
					jQuery("#footerid").css("display", "none");
				}

				//切片
				if(event.detail.slideNumber == 1) {
					jQuery("#footerid").css("display", "none");
					LoadSlide(_ConsultID);

				}
				//附件
				else if(event.detail.slideNumber == 2) {
					jQuery("#footerid").css("display", "none");
					LoadAnnex(_ConsultID);
				}
				//留言
				else if(event.detail.slideNumber == 3) {
					var ConsultStatusID = getQueryString2("ConsultStatusID");
					var type = getQueryString2("type");
					if(ConsultStatusID==1&&type!="99"&&type!="98"){
						jQuery("#footerid").css("display", "");
					}
					
					LoadMessage(_ConsultID, false);
					jQuery("#xsroll").css("z-index", -1);
				}
				//受邀
				else if(event.detail.slideNumber == 4) {
					jQuery("#footerid").css("display", "none");
					Loadinvited(); 
				}

			});

			document.getElementById('offCanvasHide').addEventListener('tap', function() {
				var offCanvasWrapper = mui('#offCanvasWrapper');
				offCanvasWrapper.offCanvas('close');
			});
			
			//预览报告
			function LookReport() {
				var jumpurl = "report.html?ConsultID=" + _ConsultID +
					"&ConsultStatusID=" + getQueryString2("ConsultStatusID") +
					"&IsRecheck=" + getQueryString2('IsRecheck') +
					"&type=" + getQueryString2("type")
					var ipad=getQueryString2("ipad");
                	if(ipad == "1") {
						if(mui.os.plus) {
							jump2(jumpurl, 'report.html', {
				
							});
						} else {
							window.location.href = jumpurl;
						}
				
					} else {
						jump(jumpurl, 'report.html', {
				
						});
					}
			}
			
			// 点击生成报告入口
			// 生成报告, 复核签名通过同一个function实现跳转到report
			function GenerateReport() {
				// 生成报告时报告字符串
				var Diagnosis = jQuery("#txt_Diagnosis").val().replace(/(<br[^>]*>|  |\s*)/g,'');

				var type=getQueryString2("type");
				var userInfo = localStorage.getItem("userInfo");
				var user = userInfo ? window.eval("(" + userInfo + ")") : "";
				var str = "";
				var Diagnosis_Remark = jQuery("#txt_remark").val().replace(/(<br[^>]*>|  |\s*)/g,'');
				var z_Mirror = jQuery("#txt_z_Mirror").val().replace(/(<br[^>]*>|  |\s*)/g,'');
				var userRecheck="";
				if(type== "97") {
					// 复核报告时报告字符串
					userRecheck=getQueryString2("Expid") 
					Diagnosis=jQuery("#txt_fh_text").val().replace(/(<br[^>]*>|  |\s*)/g,'');	
				}
				if(Diagnosis==""){
					if(type== "97") {
						mui.toast("请填写复核意见！");
					}else{
						mui.toast("请填写诊断意见！");
					}
					
				}else{
					plus.nativeUI.showWaiting("报告生成中...");
					
				var userid1=user.userid;
				var userid2=userRecheck;
				if(userRecheck==""){
					 userid1=undefined;
				     userid2=undefined;
				}
					/*URL = coreurl + "/K-RMCS.WebApi/GenerateReportsHandler.ashx?UserID1=" +
					userid1 + "&UserID2="+userid2+
					"&TextDiagnosis=" + encodeURIComponent(Diagnosis) +
					"&Diagnosis_Remark=" + encodeURIComponent(Diagnosis_Remark) +
					"&ConsultID=" + _ConsultID +
					"&ip=" + _ip +
					"&caseno=" + _CaseNo +
					"&z_Mirror=" + encodeURIComponent(z_Mirror) +
					"&port=" + _port + "";*/
					
					URL = coreurl + "/K-RMCS.WebApi/GenerateReportsHandler.ashx"; 
					// console.log(URL);
					
					// console.log('caseinfo.html: encodeURIComponent(Diagnosis)：' + Diagnosis))
					
					// 添加草稿保存
					savaDraft();
					// 生成报告预览
					$.ajax({
						url: URL,
					    dataType: 'text',
					    type: 'POST',
					    data: {
					    	'UserID1': userid1,
					    	'UserID2': userid2,
					    	'TextDiagnosis': Diagnosis,
					    	'Diagnosis_Remark': Diagnosis_Remark,
					    	'ConsultID': _ConsultID,
					    	'ip': _ip,
					    	'caseno': _CaseNo,
					    	'z_Mirror': z_Mirror,
					    	'port': _port
					    },
					    success: function(v) {
					    	/*var param = "&TextDiagnosis=" + encodeURI(Diagnosis) +
					    	"&Diagnosis_Remark=" + encodeURI(Diagnosis_Remark) +
							"&z_Mirror=" + encodeURI(z_Mirror) +
							"&ConsultStatusID=" + getQueryString2("ConsultStatusID") +
							"&IsRecheck=" + getQueryString2('IsRecheck') +
							"&ipad=" + getQueryString2('ipad') +
							"&type=" + getQueryString2("type");*/
							
							// 当报告生成成功需要保存数据到数据库时添加字符 
							var param = "&z_Mirror=" + z_Mirror +
							"&ConsultStatusID=" + getQueryString2("ConsultStatusID") +
							"&IsRecheck=" + getQueryString2('IsRecheck') +
							"&ipad=" + getQueryString2('ipad') +
							"&type=" + getQueryString2("type");
							
							// 保存数据到LocalStorage中
							var storage = window.localStorage;
							storage.TextDiagnosis = Diagnosis;
							storage.Diagnosis_Remark = Diagnosis_Remark;
							
							var ipad = getQueryString2("ipad");
							var jumpurl = "report.html?ConsultID=" + _ConsultID + param
							//var jumpurl = "report.html" + param;
							if(ipad == "1") {
								jump2(jumpurl, 'report.html', {
								});
							} else {
								jump(jumpurl, 'report.html', {
								});
							}
							plus.nativeUI.closeWaiting();
						//jQuery("#div_over").css("display", "none");
						},
						error: function(v){
							plus.nativeUI.closeWaiting();
						}
					});
				}		
			}
			
			function updateDiagnosis(Diagnosis)
			{
				jQuery.ajax(resturl + 'updateDiagnosis', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						Diagnosis: Diagnosis
					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						if(data == "1") {
							mui.toast("复核修改成功!");
						} else {
							mui.toast("复核修改异常!");
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");

						}
					}
				});

				
			}
			//退回操作
			function returnCase() {
					var ipad = getQueryString2("ipad");
					var jumpurl = "returncase.html?ConsultID=" + _ConsultID + "&type=" + getQueryString2("type");
				
					if(ipad == "1") {
						if(mui.os.plus) {
							jump2(jumpurl, 'returncase.html', {
							 	
							});
						} else {
							alert("1");
							window.location.href = jumpurl;
							
						}
					} else {
						jump(jumpurl, 'returncase.html', {

				});
				}
					}
			
			//受邀操作
			function invitedCase() {
					var ipad = getQueryString2("ipad");
					var jumpurl = "invited.html?ConsultID=" + _ConsultID + "&type=" + getQueryString2("type");
					if(ipad == "1") {
						if(mui.os.plus) {
							jump2(jumpurl, 'invited.html', {
				
							});
						} else {
							window.location.href = jumpurl;
						}
				
					} else {
				
						jump(jumpurl, 'invited.html', {
				
						});
					}
				
				}

			//保存草稿
			function savaDraft() {

					var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					jQuery.ajax(resturl + 'SaveDraft', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						Diagnosis: jQuery("#txt_Diagnosis").val().replace(/(<br[^>]*>|  |\s*)/g,''),
						Mirror: jQuery("#txt_z_Mirror").val().replace(/(<br[^>]*>|  |\s*)/g,''),
						Diagnosis_Remark: jQuery("#txt_remark").val().replace(/(<br[^>]*>|  |\s*)/g,''),
						UserID: user.userid
					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						if(data == "1") {
							mui.toast("保存成功!");
						} else {

							mui.toast("保存异常!");
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");

						}
					}
				});

			}
			
			//获取草稿
			function GetDraft() {
			    	var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					jQuery.ajax(resturl + 'GetDraftInfo', {
						data: {
							ConsultID: _ConsultID,
							UserID: user.userid
						},
						dataType: 'json', //服务器返回json格式数据
						type: 'get', //HTTP请求类型
						timeout: 10000, //超时时间设置为10秒；
						cache: false,
						success: function(data) {
							data = eval(data);
						
							if(data.length > 0) {
								for(var i = 0; i < data.length; i++) {
									console.log(data[i].Diagnosis);
								jQuery("#txt_Diagnosis").val(data[0].Diagnosis);
							    jQuery("#txt_remark").val(data[0].Diagnosis_Remark);
							    jQuery("#txt_z_Mirror").val(data[0].z_Mirror);
								}

							}

						},
						error: function(xhr, type, errorThrown) {
							if(type == 'timeout') {
								mui.toast("网络不给力，请重新操作！");
							}
						}
					});
			}
			
			//留言操作
			function sendmsg() {

				var userInfo = localStorage.getItem("userInfo");
				var user = userInfo ? window.eval("(" + userInfo + ")") : "";
				var messtext = jQuery("#msg-text").val();
				console.log(messtext);
			    messtext=messtext.replace(/(<br[^>]*>|  |\s*)/g,'');
				jQuery.ajax(resturl + 'AddMessage', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						Message: messtext,
						UserID: user.userid

					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						if(data == "1") {
							var div = "";
							var selfclass = "msg-item-self";
							var selfimg = "<i class=\"msg-user mui-icon mui-icon-person\"></i>"

							div = messagedata.join('').replace(/@message/, messtext)
								.replace(/@self/, selfclass)
								.replace(/@selfimg/, selfimg)

							jQuery("#msg-list").append(div);

							//mui('#scroll4').scroll().scrollToBottom();
							LoadMessage(_ConsultID, true);
							jQuery("#msg-text").val("");
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");

						}
					}
				});

			}
			
			//收藏操作
			function Collection(){
			 	var userInfo = localStorage.getItem("userInfo");
				var user = userInfo ? window.eval("(" + userInfo + ")") : "";
				jQuery.ajax(resturl + 'CollectionCase', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						IsCollection: _IsCollect,
						UserID: user.userid

					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						if(data == "1") {
							if(_IsCollect==0)
							{
							 _IsCollect=1;
							
							 jQuery("#btncollection").removeClass("mui-icon-star")
							 jQuery("#btncollection").addClass("mui-icon-star-filled")
							 mui.toast("收藏成功！");
							 if(mui.os.plus){
							 	plus.webview.getWebviewById("index.html").evalJS("getNumber()");
							 }
							 
							}
							else
							{
						    _IsCollect=0;
							 jQuery("#btncollection").removeClass("mui-icon-star-filled")
							 jQuery("#btncollection").addClass("mui-icon-star")
							 mui.toast("取消收藏成功！");
							 if(mui.os.plus){
							 	plus.webview.getWebviewById("index.html").evalJS("getNumber()");
							 }
							}
						
							
							
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");

						}
					}
				});
			 	
			 }
			  			 
			var ui = {
				body: document.querySelector('body'),
				footer: document.querySelector('footer'),
				footerRight: document.querySelector('.footer-right'),
				footerLeft: document.querySelector('.footer-left'),
				btnMsgType: document.querySelector('#msg-type'),
				boxMsgText: document.querySelector('#msg-text'),
				boxMsgSound: document.querySelector('#msg-sound'),
				btnMsgImage: document.querySelector('#msg-image'),
				areaMsgList: document.querySelector('#msg-list'),
				boxSoundAlert: document.querySelector('#sound-alert'),
				h: document.querySelector('#h'),
				content: document.querySelector('.mui-content2')
			};
			
			ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
			
			var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;

			var focus = false;
			ui.boxMsgText.addEventListener('tap', function(event) {

				//jQuery("footer").css("bottom", "10px")
				ui.boxMsgText.focus();
				setTimeout(function() {
					ui.boxMsgText.focus();
				}, 0);
				focus = true;
				setTimeout(function() {
					focus = false;
				}, 1000);
				event.detail.gesture.preventDefault();

			}, false);

			//点击消息列表，关闭键盘
			ui.areaMsgList.addEventListener('tap', function(event) {
				if(!focus) {
					ui.boxMsgText.blur();
				}
			})

			jQuery('.mui-off-canvas-backdrop').bind('tap', function() {
				jQuery("#offCanvasHide").focus();
			});
			
			
			window.addEventListener('resize', function() {
				var xheight = jQuery("#msg-list").height();
				mui('#scroll4').scroll().scrollTo(0, -xheight, 100);
				mui('#scroll4').scroll().refresh();
				//ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
				if(isremark == true) {

					mui('#offCanvasSideScroll').scroll().scrollTo(0, -200, 0);
					document.getElementById("txt_remark").focus();
				}
			}, false);
			
			ui.footerRight.addEventListener('release', function(event) {
				if(jQuery("#msg-text").val() != "") {
					sendmsg();
				} else {
					mui.toast("发送内容不能为空!");
				}

			});
			
			//解决长按“发送”按钮，导致键盘关闭的问题；
			ui.footerRight.addEventListener('touchstart', function(event) {
				if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
					if(jQuery("#msg-text").val() == "") {
						//jQuery("footer").css("bottom", "10px")
						msgTextFocus();
						event.preventDefault();
					}
				}
			});
			
			//解决长按“发送”按钮，导致键盘关闭的问题；
			ui.footerRight.addEventListener('touchmove', function(event) {
				if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
					if(jQuery("#msg-text").val() == "") {
						//jQuery("footer").css("bottom", "10px")
						msgTextFocus();
						event.preventDefault();
					}
				}
			});

			function msgTextFocus() {
				ui.boxMsgText.focus();
				setTimeout(function() {
					ui.boxMsgText.focus();
				}, 150);
			}
			
			var isremark = false;
			document.getElementById("txt_remark").addEventListener('tap', function(event) {
				isremark = true;
				//event.preventDefault();

			})
			document.getElementById("txt_remark").addEventListener('blur', function(event) {
				isremark = false;
				//event.preventDefault();

			})
			
			mui.back = function() {
			
				if(navigator.userAgent.indexOf("Html5Plus") < 0) { //不支持5+ API
					var ipad=getQueryString2("ipad");
					var param='?type=' + getQueryString2("type")+"&invitedtype="+getQueryString2("invitedtype")+"&ipad="+getQueryString2("ipad");
					if(ipad=="1"){
						
						 window.location.href='caselist_main.html'+param;
					}
					else{
						 window.location.href='caselist_sub.html'+param;
					}
					
				
					
				} else { //支持5+ API
				    if (!mui.os.android) {
				    	if (mui.os.iphone) {
				    		plus.webview.getWebviewById("caselist").evalJS("refresh()");
				    	} else {
				    		var isRecheck = getQueryString2("IsRecheck");
				    		var isInvited = getQueryString2("isinviteted");
				    		plus.webview.getWebviewById("caselist").evalJS('refreshByIPad(' + isRecheck + ',' + isInvited + ')');
				    	}
				    } else {
				    	plus.webview.getWebviewById("caselist").evalJS("refresh()");
				    }
				    
					plus.webview.close("caseinfo.html");
				}
			};
			
			//受邀回复
			function InvitedAsk(){
			 	var btnArray = ['否', '是'];
				mui.confirm('确定提交吗？', '提示', btnArray, function(e) {
				if(e.index == 1) {
				
					var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					var Diagnosis=jQuery("#txt_sy_zd").val().replace(/(<br[^>]*>|  |\s*)/g,'');
					if(Diagnosis!=""&&Diagnosis!=undefined){
				jQuery.ajax(resturl + 'InvitedAsk', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						ToExpID: user.userid,
						Diagnosis:Diagnosis
						

					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						if(data == "1") {
				        	mui.toast("回复成功！");
				        	if (!mui.os.android) {
				        		plus.webview.getWebviewById("caselist").evalJS("refresh()");
				        		//刷新列表(ipad左侧显示刷新)
				        		//plus.webview.getWebviewById("index.html").evalJS("getNumber()");
				        	} else {
				        		plus.webview.getWebviewById("caselist").evalJS("refresh()");
				        	}
				        	plus.webview.getWebviewById("index.html").evalJS("getNumber()");
					  		mui.back();
						}
						else{
							
							mui.toast("回复异常！");
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");
						}
					}
				});
					}else{
						mui.toast("请填写诊断意见！")
					}
				}
			});
			 	
			 }
			
			//退回复核
			function backreview(){
			  	var btnArray = ['否', '是'];
				mui.confirm('确定退回病例吗？', '提示', btnArray, function(e) {
				if(e.index == 1) {
				
					var userInfo = localStorage.getItem("userInfo");
					var user = userInfo ? window.eval("(" + userInfo + ")") : "";
					var RecheckReturn=jQuery("#txt_fh_ly").val().replace(/(<br[^>]*>|  |\s*)/g,'')
					if(RecheckReturn!=""&&RecheckReturn!=undefined){
					jQuery.ajax(resturl + 'BackReview', {
					data: JSON.stringify({
						ConsultID: _ConsultID,
						RecheckReturn: RecheckReturn
					
					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						mui.toast("退回");
						data = eval(data);
						if(data == "1") {
								mui.back();
				        	if(navigator.userAgent.indexOf("Html5Plus") >=0) { //不支持5+ API
				        			if (!mui.os.android) {
				        				plus.webview.getWebviewById("caselist").evalJS("refresh()");
				        				plus.webview.getWebviewById("index.html").evalJS("getNumber()");
				        			} else {
				        				plus.webview.getWebviewById("caselist").evalJS("refresh()");
				        			}
									
									plus.webview.getWebviewById("index.html").evalJS("getNumber()");
								} 
						}
						else{	
							mui.toast("退回异常！");
						}
					},
					error: function(xhr, type, errorThrown) {
						if(type == 'timeout') {
							mui.toast("网络不给力，请重新操作！");
						}
					}
				});
					}else{
					mui.toast("请填写退回理由！")
				}
				}
			}); 	
			}
			//加载复核意见
			function LoadReviewReturn() {
					jQuery.ajax(resturl + 'LoadReviewReturn', {
					data: JSON.stringify({
						ConsultID: _ConsultID
					}),
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					cache: false,
					success: function(data) {
						data = eval(data);
						$("#txt_fh_ly").val(data[0].RecheckReturn);
						
						// 复核意见显示
						//$("#txt_fh_text").val(data[0].Diagnosis);
					}
					
					});
			}
			
			function isComplete() {
				var URL = "http://" + getQueryString2("DiagHisIp") + ":" + getQueryString2("DiagHisPort") + "";
				console.log("判定是否站点是否连接:" + URL);
				
				if (getQueryString2("DiagHisIp") != "localhost") {
					$.ajax({
						url: URL + "/API/Ver",
						type: "GET",
						dataType: "text",
						async: true,
						timeout: 1000,
						success: function (response) {
							// "1" 状态标识云切片
							SiteStatus = 1;
						},
						error: function (e) {
							// "0" 状态标识上传中
							SiteStatus = 0;
						},
						complete: function (XMLHttpRequest, status) { //请求完成后最终执行参数
							if (status == 'timeout') {//超时,status还有success,error等值的情况
								ajaxTimeoutTest.abort();				
								SiteStatus = 0;
							}
						}
					});
				} else {
					SiteStatus = 0;
				}
			}	
			
		</script>

	</body>

</html>